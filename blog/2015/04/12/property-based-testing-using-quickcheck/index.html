
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Property-based testing using QuickCheck - Interrupted</title>
  <meta name="author" content="Guillermo Winkler">

  
  <meta name="description" content="Last year I attended Clojure/West in San Francisco, and was lucky enough to be at the talk by John Hughes, called Testing the hard stuff and staying &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://guilespi.github.com/blog/2015/04/12/property-based-testing-using-quickcheck/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Interrupted" type="application/atom+xml">
  <link href='http://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-34463415-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <div id="logo">
  	<div id="logoLeft">{</div>
  	<div id="logoText">int 3h</div>
  	<div id="logoRight">}</div>
  	<div class="clear"></div>
  </div>
  <h1><a href="/">Interrupted</a></h1>
  
    <h2>Unordered thoughts about programming, engineering and dealing with the people in the process.</h2>
  
  <div class="clear"></div>
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss email">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
    <li><a href="guillermo.winkler@gmail.com" rel="subscribe-email" title="subscribe via email">Email</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:guilespi.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/about">About</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      
        <h1 class="entry-title">Property-based Testing Using QuickCheck</h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2015-04-12T17:05:00-03:00" pubdate data-updated="true">Apr 12<span>th</span>, 2015</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>Last year I attended <a href="https://www.youtube.com/playlist?list=PLZdCLR02grLp__wRg5OTavVj4wefg69hM">Clojure/West</a> in San Francisco, and was lucky enough to be at the talk by <a href="http://www.cse.chalmers.se/~rjmh/">John Hughes</a>, called <a href="https://www.youtube.com/watch?v=zi0rHwfiX1Q">Testing the hard stuff and staying sane</a>.</p>

<p>I had been previously exposed to some of the concepts of generative testing, particularly Haskell&#8217;s own QuickCheck, but never took the time to do something with it, this talk by John Hughes really stroke a chord on the usefulness of generative -or property based- testing, and how much effort you can save by knowing when and <em>how</em> to use it.</p>

<p>I&#8217;ve been using Clojure <code>test.check</code> for a while, and since I&#8217;m preparing a <a href="http://testing.uy">conference talk</a> on the subject, I decided to write something about it.</p>

<p>So bear with me, in this two-entry blog post I&#8217;ll try to convince you why down the road, it may save your ass too.</p>

<h2>What generative testing is not</h2>

<p>Probably the reason I&#8217;ve always looked down upon generative testing, was thinking it was just about random/junk data generation, for the too-lazy-to-think-your-own-test-cases kind of attitude.</p>

<p>Well, that&#8217;s <strong>not</strong> what generative testing is about.</p>

<p>You <em>will</em> have data generators for some input domain values, but trying to generate random noise to make the program fail is just <a href="http://en.wikipedia.org/wiki/Fuzz_testing">fuzzy testing</a>, and generative testing is more than that.</p>

<p>How?</p>

<h2>On Types vs. Tests</h2>

<p><a href="http://blog.guillermowinkler.com/blog/2012/11/14/neither-types-nor-tests-will-solve-your-data-coverage-problem/">I&#8217;ve written before</a> about the difficulty of using types to prove your program is correct. Some people will always say you can do it with type systems(and types even more complex than the program under proof), and you can <a href="https://coq.inria.fr/a-short-introduction-to-coq">always use Coq</a>.</p>

<p>But for everyday programming languages and type systems it&#8217;s not that easy, say for instance this <code>Java</code> function (assuming such thing exists).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kt">int</span> <span class="nf">f1</span><span class="o">(</span><span class="kt">int</span> <span class="n">x</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">1</span><span class="o">/</span><span class="n">x</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>You can say just by looking at the function, that any integer except zero will succeed.</p>

<p>In this other case:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kt">int</span> <span class="nf">f2</span><span class="o">(</span><span class="n">String</span> <span class="n">x</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="na">length</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The function will succeed except when <code>x</code> is <code>null</code>.</p>

<p>So assuming that&#8217;s expected behavior, you can write some tests to check on those special failure cases.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Test</span><span class="o">(</span><span class="n">expected</span><span class="o">=</span><span class="n">ArithmeticException</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">testDivideByZero</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">f1</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//this is just a unit test</span>
</span><span class='line'><span class="nd">@Test</span>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">testUnity</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">assertEquals</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">f1</span><span class="o">(</span><span class="mi">1</span><span class="o">));</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@Test</span><span class="o">(</span><span class="n">expected</span><span class="o">=</span><span class="n">NullPointerException</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">testNullPointerException</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">f2</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>But for the sake of making and argument, assume you&#8217;re testing <code>openssl</code> and this is the function you have&#8230;</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">int</span> <span class="nf">dtls1_process_heartbeat</span><span class="p">(</span><span class="n">SSL</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="p">...</span>    
</span><span class='line'>  <span class="cm">/* Read type and payload length first */</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">&gt;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">s3</span><span class="o">-&gt;</span><span class="n">rrec</span><span class="p">.</span><span class="n">length</span><span class="p">)</span>
</span><span class='line'>      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* silently discard */</span>
</span><span class='line'>  <span class="n">hbtype</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>  <span class="n">n2s</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">payload</span><span class="p">);</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">payload</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">&gt;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">s3</span><span class="o">-&gt;</span><span class="n">rrec</span><span class="p">.</span><span class="n">length</span><span class="p">)</span>
</span><span class='line'>      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* silently discard per RFC 6520 sec. 4 */</span>
</span><span class='line'>  <span class="n">pl</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">hbtype</span> <span class="o">==</span> <span class="n">TLS1_HB_REQUEST</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>      <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="o">*</span><span class="n">bp</span><span class="p">;</span>
</span><span class='line'>      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">write_length</span> <span class="o">=</span> <span class="mi">1</span> <span class="cm">/* heartbeat type */</span> <span class="o">+</span>
</span><span class='line'>                      <span class="mi">2</span> <span class="cm">/* heartbeat length */</span> <span class="o">+</span>
</span><span class='line'>                      <span class="n">payload</span> <span class="o">+</span> <span class="n">padding</span><span class="p">;</span>
</span><span class='line'>      <span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">write_length</span> <span class="o">&gt;</span> <span class="n">SSL3_RT_MAX_PLAIN_LENGTH</span><span class="p">)</span>
</span><span class='line'>          <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="cm">/* Allocate memory for the response, size is 1 byte</span>
</span><span class='line'><span class="cm">      * message type, plus 2 bytes payload length, plus</span>
</span><span class='line'><span class="cm">      * payload, plus padding</span>
</span><span class='line'><span class="cm">      */</span>
</span><span class='line'>      <span class="n">buffer</span> <span class="o">=</span> <span class="n">OPENSSL_malloc</span><span class="p">(</span><span class="n">write_length</span><span class="p">);</span>
</span><span class='line'>      <span class="n">bp</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="cm">/* Enter response type, length and copy payload */</span>
</span><span class='line'>      <span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">TLS1_HB_RESPONSE</span><span class="p">;</span>
</span><span class='line'>      <span class="n">s2n</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">bp</span><span class="p">);</span>
</span><span class='line'>      <span class="n">memcpy</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">pl</span><span class="p">,</span> <span class="n">payload</span><span class="p">);</span>
</span><span class='line'>      <span class="n">bp</span> <span class="o">+=</span> <span class="n">payload</span><span class="p">;</span>
</span><span class='line'>      <span class="cm">/* Random padding */</span>
</span><span class='line'>      <span class="n">RAND_pseudo_bytes</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">padding</span><span class="p">);</span>
</span><span class='line'>    <span class="p">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>Unless you&#8217;ve been living under a rock, you should have heard about <a href="http://heartbleed.com/">the heartbleed openssl bug</a>, and it&#8217;s just what you think, the bug was in the heartbeat processing function above, and <a href="http://git.openssl.org/gitweb/?p=openssl.git;a=commitdiff;h=96db902">this is the patch with the fix</a>.</p>

<p><img class="center" src="/images/blog/opensslpatch.png" width="680" height="780" title="'Openssl heartbleed patch'" ></p>

<p>Who was the motherfucker that missed that unit test, huh?</p>

<p>When the function logic is more complex, it&#8217;s exponentially more difficult to define both types and tests that make us feel more confident about pushing our nasty bits of code to a production environment.</p>

<p>And that&#8217;s because the possible states our system or function can be, expand like hell when new variables and conditional branches are added (more on this later).</p>

<h2>Code Coverage vs. Domain Coverage</h2>

<p>Looking at the function above you can see the problem is not on some untested code path, but on some <em>values</em> used on function invocation.</p>

<p>Some people aim for 100% code coverage, according to <a href="http://en.wikipedia.org/wiki/Code_coverage">Wikipedia</a></p>

<p><em>In computer science, code coverage is a measure used to describe the degree to which the source code of a program is tested by a particular test suite. A program with high code coverage has been more thoroughly tested and has a lower chance of containing software bugs than a program with low code coverage.</em></p>

<p>Which is great, but since you can have 100% code coverage of the <code>1/x</code> function, but regarding domain coverage (for which values of <code>x</code> the function works as expected) you have nothing.</p>

<p><strong>Code coverage without domain coverage is just half the picture.</strong></p>

<p>Even unit tests prove <em>almost</em> nothing.</p>

<h2>Tests do not prove correctness</h2>

<p>There&#8217;s a great quote by <a href="http://en.wikiquote.org/wiki/Edsger_W._Dijkstra">Edsger Dijkstra</a> from Notes on Structured Programming that says</p>

<p><em>Program testing can be used to show the presence of bugs, but never to show their absence!</em></p>

<p>Which is to say, no matter how many unit tests you write, you&#8217;re only proving that your program works (or fails) for the set of inputs you have selected when writing your tests.</p>

<p>It doesn&#8217;t say a thing about the generalities or about a general property of the system or function under test.</p>

<h2>What is generative testing?</h2>

<p>So what <em>is</em> generative testing?</p>

<p>In generative testing you describe some properties your system or function must comply with, and the test runner provides randomized data to check if the property holds for that data, that&#8217;s why it&#8217;s also known as <code>property-based</code> testing.</p>

<p>A <code>property</code> is a high-level specification of behavior that should hold for a range of data points.</p>

<p>So a property works somewhat like a <em>domain iterator</em>, bringing a little bit closer types and tests.</p>

<p>Since you&#8217;re defining how the system should behave for a particular <em>domain</em> of values, not when the program is compiled, but when it&#8217;s <strong>run</strong>.</p>

<h2>Why random data generation is important?</h2>

<p>In the StrangeLoop 2014 conference, Joe Armstrong gave a talk called <a href="https://www.youtube.com/watch?v=lKXe3HUG2l4">The mess we&#8217;re in</a>, where he discussed system&#8217;s complexity, go watch it since it&#8217;s real fun.</p>

<p>He says that a <code>C</code> program with only six <code>32 bit</code> integers, has the same number of states that atoms exist on the planet, so testing your program by computing all combinations it&#8217;s going to take a <em>really long</em> time.</p>

<p>And if it&#8217;s almost impossible to find the number of states computationally, imagine trying to find the number of possible failing states <em>manually</em>.</p>

<p>I&#8217;ve been in the position of having to hunt a bug that occurs only once a year in a system processing millions of transactions daily, and it&#8217;s not fun at all. Pray to the logging gods the proper piece of information revealing the culprit is logged, so you don&#8217;t have to wait another year for the bug to show up.</p>

<p>If your software runs inside a car, would you wait for the next deadly crash to analyze that dead-driver log file? Maybe that&#8217;s why <a href="http://www.quviq.com/volvo-quickcheck/">Volvo uses QuickCheck</a> to test embedded systems.</p>

<p>Generative testing helps you put and test your system in so many different states it would be impossible to do manually.</p>

<h2>What&#8217;s in a property</h2>

<p>So, should we throw away all of our type systems and unit tests?</p>

<p>Not so fast, property based testing is not a <strong>replacement</strong> for types nor for unit tests.</p>

<p>Haskell and Scala both have their frameworks for property based testing (QuickCheck and ScalaTest) and are strongly typed languages.</p>

<p>Property based testing helps us define considerations for our programs where type systems do not reach, and where dynamically typed languages have a void.</p>

<p>So what does a property look like?</p>

<p>All concepts so far hold true for any language with a generative testing framework, many re-implementations exist from the <a href="http://en.wikipedia.org/wiki/QuickCheck">original QuickCheck version</a>, from <code>C</code>, <code>C++</code>, <code>Ruby</code>, <code>Clojure</code>, <code>Javascript</code>, <code>Java</code>, <code>Scala</code>, etc. So now I will show you a couple of examples in different languages, just for you to grasp the basic property definition semantics, which is quite similar along the implementations.</p>

<p>These examples are not meant to show how powerful generative testing can be, yet.</p>

<h3>Sorting in Javascript</h3>

<p>Let&#8217;s say you want to test a <code>sort</code> function of yours, and instead of specifying individual test cases for particular arrays of integers, you define a property, which says that after sorting the array, the last element should always be greater than the first one.</p>

<p>This is what the property looks like in Javascript&#8217;s <a href="www.jscheck.org">JSCheck</a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">JSC</span><span class="p">.</span><span class="nx">reps</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span><span class='line'><span class="nx">JSC</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span>
</span><span class='line'>    <span class="s2">&quot;First is lower than last after sort&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="kd">function</span> <span class="p">(</span><span class="nx">verdict</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">sorted</span> <span class="o">=</span> <span class="nx">v</span><span class="p">.</span><span class="nx">sort</span><span class="p">();</span>
</span><span class='line'>        <span class="k">return</span> <span class="nx">verdict</span><span class="p">(</span><span class="nx">sorted</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="nx">sorted</span><span class="p">[</span><span class="nx">sorted</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]);</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="p">[</span>
</span><span class='line'>        <span class="nx">JSC</span><span class="p">.</span><span class="nx">array</span><span class="p">([</span><span class="nx">JSC</span><span class="p">.</span><span class="nx">integer</span><span class="p">()]])</span>
</span><span class='line'>    <span class="p">]</span>
</span><span class='line'><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>You don&#8217;t say which particular arrays, just any array of integers must comply with the property, the framework will generate values for you (in this case 10 repetitions will be run).</p>

<p>This is the result:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">First</span> <span class="nx">is</span> <span class="nx">lower</span> <span class="nx">than</span> <span class="nx">last</span> <span class="nx">after</span> <span class="nx">sort</span><span class="o">:</span> <span class="mi">10</span> <span class="nx">cases</span> <span class="nx">tested</span><span class="p">,</span> <span class="mi">0</span> <span class="nx">pass</span><span class="p">,</span> <span class="mi">10</span> <span class="nx">fail</span>
</span><span class='line'> <span class="nx">FAIL</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">([</span><span class="mi">3</span><span class="p">])</span>
</span><span class='line'> <span class="nx">FAIL</span> <span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">([</span><span class="mi">5</span><span class="p">])</span>
</span><span class='line'> <span class="nx">FAIL</span> <span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="p">([</span><span class="mi">7</span><span class="p">])</span>
</span></code></pre></td></tr></table></div></figure>


<p>Did you spot when the property doesn&#8217;t hold?</p>

<h3>Sorting in Clojure</h3>

<p>This is what the same property looks like in Clojure&#8217;s <a href="https://github.com/clojure/test.check">test.check</a>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">prop-sorted-first-less-than-last</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">prop/for-all</span> <span class="p">[</span><span class="nv">v</span> <span class="p">(</span><span class="nf">gen/not-empty</span> <span class="p">(</span><span class="nf">gen/vector</span> <span class="nv">gen/int</span><span class="p">))]</span>
</span><span class='line'>    <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">s</span> <span class="p">(</span><span class="nb">sort </span><span class="nv">v</span><span class="p">)]</span>
</span><span class='line'>      <span class="p">(</span><span class="nb">&lt; </span><span class="p">(</span><span class="nb">first </span><span class="nv">s</span><span class="p">)</span> <span class="p">(</span><span class="nb">last </span><span class="nv">s</span><span class="p">)))))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">tc/quick-check</span> <span class="mi">200</span> <span class="nv">prop-sorted-first-less-than-last</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>With the following result:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'>   <span class="nv">=&gt;</span> <span class="p">{</span><span class="ss">:result</span> <span class="nv">false</span>, <span class="ss">:failing-size</span> <span class="mi">0</span>, <span class="ss">:num-tests</span> <span class="mi">1</span>, <span class="ss">:fail</span> <span class="p">[[</span><span class="mi">3</span><span class="p">]]</span>,
</span><span class='line'>       <span class="ss">:shrunk</span> <span class="p">{</span><span class="ss">:total-nodes-visited</span> <span class="mi">5</span>, <span class="ss">:depth</span> <span class="mi">2</span>, <span class="ss">:result</span> <span class="nv">false</span>,
</span><span class='line'>                <span class="ss">:smallest</span> <span class="p">[[</span><span class="mi">0</span><span class="p">]]}}</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you see, <strong>both fail</strong>, since they doesn&#8217;t hold for single element arrays.</p>

<p>The basic semantic for both languages is the same, you need:</p>

<ul>
<li>A property name (or claim in JSCheck)</li>
<li>Some data generator for your input values</li>
<li>A verdict or testing function who validates the property</li>
</ul>


<blockquote><p>This encourages a higher level approach to testing in the form of abstract invariant functions should satisfy universally.</p><footer><strong>http://book.realworldhaskell.org/read/testing-and-quality-assurance.html</strong></footer></blockquote>


<h2>Shrinking</h2>

<p>One of the best features of QuickCheck is the ability to shrink your failure cases to the minimum failing case (not all the implementations have it by the way).</p>

<p>When generating random data, you may end up with a failing case too big to rationalize (for instance a thousand elements vector), but it doesn&#8217;t necessarily means that all the 1000 elements are needed for the function under test to fail.</p>

<p>When QuickCheck finds a failing case, it tries to shrink the input data to the <em>smallest</em> failing case.</p>

<p>This is a powerful feature if you don&#8217;t want to repeat many unnecessary steps in order to reproduce a problem.</p>

<p>A simple example to illustrate the feature comes from <code>test.check</code> samples.</p>

<p>Here a property must hold for all integer vectors, and it is that no vector should have the element <code>42</code> in it.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">prop-no-42</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">prop/for-all</span> <span class="p">[</span><span class="nv">v</span> <span class="p">(</span><span class="nf">gen/vector</span> <span class="nv">gen/int</span><span class="p">)]</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">not </span><span class="p">(</span><span class="nb">some </span><span class="o">#</span><span class="p">{</span><span class="mi">42</span><span class="p">}</span> <span class="nv">v</span><span class="p">))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>When the tests are run, <code>test.check</code> find a failing case being the vector <code>[10 1 28 40 11 -33 42 -42 39 -13 13 -44 -36 11 27 -42 4 21 -39]</code>, which is <strong>not</strong> the minimum failing case.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">tc/quick-check</span> <span class="mi">100</span> <span class="nv">prop-no-42</span><span class="p">)</span>
</span><span class='line'><span class="c1">;; =&gt; {:result false,</span>
</span><span class='line'>       <span class="ss">:failing-size</span> <span class="mi">45</span>,
</span><span class='line'>       <span class="ss">:num-tests</span> <span class="mi">46</span>,
</span><span class='line'>       <span class="ss">:fail</span> <span class="p">[[</span><span class="mi">10</span> <span class="mi">1</span> <span class="mi">28</span> <span class="mi">40</span> <span class="mi">11</span> <span class="mi">-33</span> <span class="mi">42</span> <span class="mi">-42</span> <span class="mi">39</span> <span class="mi">-13</span> <span class="mi">13</span> <span class="mi">-44</span> <span class="mi">-36</span> <span class="mi">11</span> <span class="mi">27</span> <span class="mi">-42</span> <span class="mi">4</span> <span class="mi">21</span> <span class="mi">-39</span><span class="p">]]</span>,
</span><span class='line'>       <span class="ss">:shrunk</span> <span class="p">{</span><span class="ss">:total-nodes-visited</span> <span class="mi">38</span>,
</span><span class='line'>                <span class="ss">:depth</span> <span class="mi">18</span>,
</span><span class='line'>                <span class="ss">:result</span> <span class="nv">false</span>,
</span><span class='line'>                <span class="ss">:smallest</span> <span class="p">[[</span><span class="mi">42</span><span class="p">]]}}</span>
</span></code></pre></td></tr></table></div></figure>


<p>So it starts shrinking the failing case until it reaches the smallest vector for which the property doesn&#8217;t hold, which is <code>[42]</code>.</p>

<p>Unfortunately <code>JSCheck</code> doesn&#8217;t shrink the failure cases, but <a href="http://jsverify.github.io/">jsverify</a> does, so if you want some shrinking on Javascript give it a try.</p>

<h2>Final thoughts</h2>

<p>Since QuickCheck depends on generators to cover the domain, we need to consider those domains may be infinite or very large, so it may be impossible to find the offending failure cases. None the less, we know that by running long enough or a large enough number of tests, we have better odds of finding a problem.</p>

<p>Regarding the name, <code>property-based</code> testing is a much better name than <code>generative</code> testing, since the later gives the idea that it&#8217;s about generating data, when it&#8217;s truly about function and system properties.</p>

<p>The higher level approach of property definition, coupled with the data generation and shrinking features provided by QuickCheck, really helps the case of having something more closer to <em>proofs</em> about how your system behaves.</p>

<p>In the next post I&#8217;ll write about finite state machine testing using <code>test.check</code> and show more complex examples, stay tuned.</p>

<p>I&#8217;m <a href="https://twitter.com/guilespi">guilespi</a> on Twitter, reach out!</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Guillermo Winkler</span></span>

      








  


<time datetime="2015-04-12T17:05:00-03:00" pubdate data-updated="true">Apr 12<span>th</span>, 2015</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/clojure/'>clojure</a>, <a class='category' href='/blog/categories/quickcheck/'>quickcheck</a>, <a class='category' href='/blog/categories/testing/'>testing</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://guilespi.github.com/blog/2015/04/12/property-based-testing-using-quickcheck/" data-via="" data-counturl="http://guilespi.github.com/blog/2015/04/12/property-based-testing-using-quickcheck/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left articlenav" href="/blog/2014/04/27/decompiling-clojure-iii/" title="Previous Post: Decompiling Clojure III, Graph all the things">&laquo; Decompiling Clojure III, Graph all the things</a>
      
      
        <a class="basic-alignment right articlenav" href="/blog/2015/04/12/verifying-state-machine-behavior-using-test-dot-check/" title="Next Post: Verifying state machine behavior using test.check">Verifying state machine behavior using test.check &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/04/12/verifying-state-machine-behavior-using-test-dot-check/">Verifying state machine behavior using test.check</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/04/12/property-based-testing-using-quickcheck/">Property-based testing using QuickCheck</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/04/27/decompiling-clojure-iii/">Decompiling Clojure III, Graph all the things</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/04/21/decompiling-clojure-ii/">Decompiling Clojure II, The Compiler</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/04/13/decompiling-clojure-i/">Decompiling Clojure I</a>
      </li>
    
  </ul>
</section>






  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Guillermo Winkler -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'interrupted';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://guilespi.github.com/blog/2015/04/12/property-based-testing-using-quickcheck/';
        var disqus_url = 'http://guilespi.github.com/blog/2015/04/12/property-based-testing-using-quickcheck/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
